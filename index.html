<!DOCTYPE html>
<html>
  <head>
    <title>Blockroad Image Upload</title>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <script src="https://wzrd.in/standalone/buffer"></script>
    <script src="https://unpkg.com/ipfs-api@9.0.0/dist/index.js"
    integrity="sha384-5bXRcW9kyxxnSMbOoHzraqa7Z0PQWIao+cgeg327zit1hz5LZCEbIMx/LWKPReuB"
    crossorigin="anonymous"></script>

  <script type="text/javascript">
    function upload() {
      var hash;
      const reader = new FileReader();
      reader.onloadend = function() {
        const ipfs = window.IpfsApi('localhost', 5001) // Connect to IPFS
        const buf = buffer.Buffer(reader.result) // Convert data into buffer
        ipfs.files.add(buf, (err, result) => { // Upload buffer to IPFS
          if(err) {
            console.error(err)
            return
          }
          let url = `https://ipfs.io/ipfs/${result[0].hash}`
          let hash = result[0].hash;

          console.log(`Url --> ${url}`)
          document.getElementById("url").innerHTML= url
          document.getElementById("url").href= url
          document.getElementById("output").src = url
        })
      }
      const photo = document.getElementById("photo");
      reader.readAsArrayBuffer(photo.files[0]); // Read Provided File
    

    if (typeof web3 !== 'undefined') {
        web3 = new Web3(web3.currentProvider);
      } else {
        // set the provider you want from Web3.providers
        web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:8545"));
      }

    var mySenderAddress = web3.eth.getAccounts(accounts => console.log(accounts[0]))


    //abi is too large and causing build error
    let abi = "[{"constant":false,"inputs":[],"name":"buyData","outputs":[{"name":"","type":"bytes32"}],"payable":true,"stateMutability":"payable","type":"function"},{"constant":true,"inputs":[],"name":"owner","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"price","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"newPrice","type":"uint256"}],"name":"changePrice","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"inputs":[{"name":"_hash","type":"bytes32"},{"name":"_price","type":"uint256"}],"payable":false,"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":false,"name":"receiver","type":"address"},{"indexed":false,"name":"hash","type":"bytes32"}],"name":"BoughtData","type":"event"}]";

    let bytecode = "6060604052341561000f57600080fd5b60405161068638038061068683398101604052808051820191906020018051906020019091908051820191906020018051906020019091905050336000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550836002908051906020019061009f9291906100d2565b5080600381600019169055508260018190555081600490805190602001906100c89291906100d2565b5050505050610177565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f1061011357805160ff1916838001178555610141565b82800160010185558215610141579182015b82811115610140578251825591602001919060010190610125565b5b50905061014e9190610152565b5090565b61017491905b80821115610170576000816000905550600101610158565b5090565b90565b610500806101866000396000f30060606040526004361061006d576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff1680634a79d50c14610072578063749bb234146101005780638da5cb5b14610126578063a035b1fe1461017b578063a2b40d19146101a4575b600080fd5b341561007d57600080fd5b6100856101c7565b6040518080602001828103825283818151815260200191508051906020019080838360005b838110156100c55780820151818401526020810190506100aa565b50505050905090810190601f1680156100f25780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b610108610265565b60405180826000191660001916815260200191505060405180910390f35b341561013157600080fd5b610139610444565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b341561018657600080fd5b61018e610469565b6040518082815260200191505060405180910390f35b34156101af57600080fd5b6101c5600480803590602001909190505061046f565b005b60028054600181600116156101000203166002900480601f01602080910402602001604051908101604052809291908181526020018280546001816001161561010002031660029004801561025d5780601f106102325761010080835404028352916020019161025d565b820191906000526020600020905b81548152906001019060200180831161024057829003601f168201915b505050505081565b600080346001541115151561027957600080fd5b33600354604051808373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166c01000000000000000000000000028152601401826000191660001916815260200192505050604051809103902090507f4c40a32c6c8b88416e4dcc505dc73d38ad5dc28e9c673c2bdcbe658f535f942c33600283604051808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020018060200183600019166000191681526020018281038252848181546001816001161561010002031660029004815260200191508054600181600116156101000203166002900480156103cc5780601f106103a1576101008083540402835291602001916103cc565b820191906000526020600020905b8154815290600101906020018083116103af57829003601f168201915b505094505050505060405180910390a16000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff166108fc349081150290604051600060405180830381858888f19350505050151561043d57600080fd5b8091505090565b6000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1681565b60015481565b6000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff161415156104ca57600080fd5b80600181905550505600a165627a7a72305820c80836835253f79a258defb9146189d73487346f40ad0147865465f3bb6a35e10029";
    let gasEstimate = web3.eth.estimateGas({data: bytecode});
    let MyContract = web3.eth.contract(JSON.parse(abi));

    var price = web3.toWei(GET.price, ether);

  var myContractReturned = MyContract.new(hash, price, {
   from:mySenderAddress,
   data:bytecode,
   gas:gasEstimate}, function(err, myContract){
    if(!err) {
       // NOTE: The callback will fire twice!
       // Once the contract has the transactionHash property set and once its deployed on an address.

       // e.g. check tx hash on the first call (transaction send)
       if(!myContract.address) {
           console.log(myContract.transactionHash) // The hash of the transaction, which deploys the contract
       
       // check address on the second call (contract deployed)
       } else {
           console.log(myContract.address) // the contract address
       }

       // Note that the returned "myContractReturned" === "myContract",
       // so the returned "myContractReturned" object will also get the address set.
    }
  });

  // Deploy contract syncronous: The address will be added as soon as the contract is mined.
  // Additionally you can watch the transaction by using the "transactionHash" property
  var myContractInstance = MyContract.new(param1, param2, {data: myContractCode, gas: 300000, from: mySenderAddress});
  myContractInstance.transactionHash // The hash of the transaction, which created the contract
  myContractInstance.address // undefined at start, but will be auto-filled later
}

    function printAccountBalance() {
        var GET = {};
        var query = window.location.search.substring(1).split("&");
        for (var i = 0, max = query.length; i < max; i++)
        {
          if (query[i] === "") // check for trailing & with no param
            continue;
          var param = query[i].split("=");
          GET[decodeURIComponent(param[0])] = decodeURIComponent(param[1] || "");
        }
        var account = GET.account;

        var balanceWei = web3.eth.getBalance(account).toNumber();
        var balance = web3.fromWei(balanceWei, 'ether');

        document.write('[' + account + ']<br><br>')
        document.write(balance + ' Ether');     
    }


    function 
    </script>
  </head>

  <body>
    <form action="/">
      <fieldset>
      
      <form method="GET" action="index.html">
      Enter an account: <input type="text" size="50" name="account">
      <br>
      <form method="GET" action="index.html">
      Enter a price in Ether: <input type="text" size="50" name="price">
      <br>
      <form method="GET" action="index.html">
      Enter a title: <input type="text" size="50" name="title">
      <br>
       <form method="GET" action="index.html">
      Enter a description: <input type="text" size="50" name="description">
    
    </form>
        <legend>Upload photo</legend>
        <input type="file" name="photo" id="photo">
        <button type="button" onclick="upload()">Upload</button>
      </fieldset>
    </form>
    </br>
    </br>
    <a id="url"></a>
    </br>
    </br>
    <img id="output">
  </body>
</html>